---
title: "ccc"
author: "Pierre Nouvellet"
date: "2019-07"
---

```{r options, include = FALSE, message = FALSE, warning = FALSE, error = FALSE}
library(knitr)
library(Hmisc)

opts_chunk$set(collapse = TRUE)

opts_chunk$set(fig.path='figs/', fig.keep='high', 
               dev=c('png'), fig.width=10, fig.height=6, cache=FALSE,
               tidy=FALSE, warning=FALSE, fig.show="asis"
 	       )

```


NEED to do:
1) input

# Input

```{r}

date_week_finishing <-  as.Date('22/03/2020',format = '%d/%m/%Y')

day.project <- 7
t.window.range <- 7

rep <- 2e4

```

# Read data

```{r}
d <- readRDS(file = paste0('../Team.input/data_',date_week_finishing,'.rds'))

D <- d$D_active_transmission
I <- d$I_active_transmission
country <- d$Country
N_geo <- length(country)
date_week_finishing <- d$date_week_finishing

```


```{r}

colSums(D[,-1])/colSums(I[,-1])

date <- D$dates[7:nrow(D)]
moving_DtoI <- list()

med <- matrix(NA,nrow(D)-6,N_geo)
low <- med
up <- med

for (i in 1:nrow(med)){
  temp <- binconf(x = colSums(D[i:(i+6),-1]) , n = colSums(I[i:(i+6),-1]),alpha = .05, method = 'exact')
  med[i,] <- temp[,1]
  low[i,] <- temp[,2]
  up[i,] <- temp[,3]
}

med[which((med==Inf))] <- NA

for (i in 1:N_geo){
  moving_DtoI[[as.character(country[i])]] <- data.frame(date = date,
                                                        ratio = med[,i],
                                                        lower = low[,i],
                                                        upper = up[,i])
}

```

Average and 95%CI for ratio of deaths to reported cases for moving window of 7 days since march.

The ratio ignore the delay between death and case being reported. 

Unless the true number of daily cases is declining very sharply, the ratio is expected to be below 1.

For a given country, if the reporting of new cases and deaths were both constant over time one would expect:

1) The ratio decreases when the epidemic is growing. The exponential growth rate means that the ratio between case on one day relative to case in the past is growing (i.e. the growth rate is not linear). Therefore the number of death (equivalent to a proportion of reported cases in the past) divided by the number of cases in the same period is declining.

2) The ratio reamins constant when the epidemic is stable; i.e. same number of cases today and in the past.

1) The ratio increases when the epidemic is delcining. The exponential decline means that the ratio between case on one day relative to case in the past is decreasing.

Any other trend suggests a change in the reporting. 
For instance, an increase in the ratio while incidence is still growing exponetially is a clear indication of lower reporting of cases.

In the plots below, reported deaths (red) and cases (black) are shown rescaled.

```{r}

f <- which(moving_DtoI[[1]]$date >= as.Date(c('01/03/2020'),format = '%d/%m/%Y'))

layout(matrix(1:4,2,2))
for (i in 1:N_geo){
  a <- moving_DtoI[[i]]
  plot(a$date,a$ratio,lwd = 2,
       ylim = c(0,max(a[f,2:4],na.rm=TRUE)),
       type='l',
       xlim = c(as.Date(c('01/03/2020'),format = '%d/%m/%Y'),date_week_finishing),
       bty ='n', main = country[i],col = rgb(0,0,1),
       xlab = '', ylab = 'ratio D to I') 
  
  polygon(c(a$date,rev(a$date)),
          c(a$lower,rev(a$upper)),
          border = NA,
          col = rgb(0,0,1,0.2))
  
  inc <- cbind(I[f+6,i+1],D[f+6,i+1])
  lines(a$date[f], inc[,1]/max(inc[,1])*max(a[f,2:4]), type = 'p', pch=16,col='black')
  lines(a$date[f], inc[,2]/max(inc[,2])*max(a[f,2:4]), type = 'p', pch=16,col='red')
  
  if(i==3){
  legend('topleft',legend = c('ratio','death','reported cases'),bty='n',
         lwd=c(3,NA,NA),pch=c(NA,16,16),col = c(rgb(0,0,1),rgb(1,0,0),rgb(0,0,0)))
  }
}

```

Average and 95%CI for ratio of deaths to reported cases for the last 4 days.

```{r}

limits <- seq(date_week_finishing-13,date_week_finishing,by = 1)
f <- which(D$dates %in% limits)
temp <- binconf(x = colSums(D[f,-1]) , n = colSums(I[f,-1]),alpha = .05, method = 'exact')

summary_14days <- data.frame(country = country,
                      death = colSums(D[f,-1]),
                      cases = colSums(I[f,-1]),
                      median = round(temp[,1],digits = 3)*100,
                      lower = round(temp[,2],digits = 3)*100,
                      upper = round(temp[,3],digits = 3)*100)
summary_14days <- summary_14days[order(summary_14days$median,decreasing = TRUE),]
write.csv(summary_14days,file = 'summary_DeathToRepoted_14days.csv')

```

