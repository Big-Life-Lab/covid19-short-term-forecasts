---
output: 
html_document:
  css: style.css
citation_package: natbib
keep_tex: false
fig_caption: true
latex_engine: pdflatex
title: "Short-term forecasts of cases and deaths of COVID-19 in multiple countries"
author:
- name: Sangeeta Bhatia and Pierre Nouvellet
affiliation: Imperial College London
abstract: 
keywords: 
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
spacing: double
bibliography: 
biblio-style: apsr
endnote: no
---

```{r echo = FALSE, warning = FALSE, message = FALSE}
library(ggplot2)
library(ggpubr)
library(dplyr)
library(drake)
library(kableExtra)
raw_data <- drake::readd(raw_data)
raw_data <- dplyr::rename(raw_data, country = "Countries.and.territories")


```
# Introduction {.tabset .tabset-fade .tabset-pills}

As of `r format(Sys.time(), '%B %d, %Y')`, there have more than
351,000 cases of COVID-19 across the world, with more than 15,000
deaths. In this report, we use the reported number of deaths
of COVID-19 to make short term forecasts of the trajectory of the
outbreak. 

## Methods 

The objective of this project is to forecast for the daily number of COVID-19 deaths in countries with sustained local transmission. We aim to produce weekly forecasts every Monday. Multiple teams are involved, each producing weekly forecasts and a centralised team also produces an ensemble forecast.

We use reported deaths rather than pretored cases, as the former ascertainment of the former is likely to be much more stable over time than the later. The ascertainment of deaths is also likely to be much higher then for cases, as most cases will show mild (if any) symptoms.

As we forecasting deaths, the latest estimates of trasnsmissibility reflect the epidemiological conditions when those dying were infected. Therefore, adisadvantage in using death, is this delay between case reporting and death.

As weel as forecasting, we also use reported death and past report cases (using a fix delay) to analyse the reporting trends per country. If the reporting of cases and death was perfect, as well as the delay between reporting and death fixed and known, the ratio of death to delayed cases would be exactly the Case Fatalty Ratio (CFR).

Forecasts are produced weekly for based on data available on the last Sunday of the previous week. Forecasts are produced only for countries that reported at least 5 deaths in the previous week and 10 deaths in the previous two weeks. For the purpose of our analysis, we assume those countries show strong evidence active and sustained local transmission.

Importantly, all weekly forecasts rely on estimation of current level of transmissibility. Given we are forecasting number of daily deaths expected, current transmissibility reflects epidemiological dynamics when the cases who died became infected. 

Therefore, current estimates of transmissibility based on death reflect transmission events that occur about two to three weeks ago, given the delays between infection and death. As a consequence, in the best case scenario, the impact of current control on estimated of transmissibility will be quantifiable with a two to three weeks delay.

In the results section of each model output, a 'methods' section outlines briefly the methodology used to produce forecasts.



While death counts are used for the main analysis and producing forecasts. Reported cases and the death to reported cases ratios for each country are show in the 'Supplementary Information' section.


## Projections and Rt Estimates {.tabset .tabset-fade .tabset-pills} 

### Ensemble Model {.tabset .tabset-fade .tabset-pills} 

#### Projections

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6.4}

obs <- drake::readd("obs")
ensb_pred <- drake::readd("ensemble_model_qntls")
ensb_pred1 <- ensb_pred[ensb_pred$si == "si_1", ]
ensb_pred1$date <- as.Date(ensb_pred1$date)
projection_plot(obs, ensb_pred1)

```

#### Summary of results

```{r echo = FALSE, warning = FALSE, message = FALSE}
x <- drake::readd("fmtd_ensemble_weekly_qntls")[[1]]

knitr::kable(
    x,
    align = "l",
    digits = 2
) %>% kable_styling()

```

### Model 1 {.tabset .tabset-fade .tabset-pills} 

#### Methods


Estimating current transmissibility

We use a previously described approach [cori et al. 2013] to quantify transmissibility during the calibration period, from the incidence of death time series, assuming a certain distribution for the serial interval for death (the time between death in a case and death in their infector). Here, we assumed that the serial interval distribution for death was similar to the classical serial interval distribution (the time between onset of symptom in a case and onset of symptom in their infector).

Our main analysis assume a gamma distributed serial of mean 4.8 days and standard deviation of 2.7 days following [Wang and Teunis, 2020].

Include figure of histogram of SI

The serial interval above might be biased toward lower values given the observation bias whereby, in contact tracing studies, long serial interval tend to be under-represented. To account for this, as a sensitivity analysis, we also ran our analysis with an alternative longer serial interval of mean 6.48 days and standard deviation of 3.83 days [Ferguson 2020, report 9]. Results for this longer interval are presented in the supplementary information section. Most importantly, while using such longer serial interval has very little impact on the weekly forecast produced, it results in much higher estimated of transmissibility.

We assumed that transmissibility was constant throughout the calibration period, and measured it through the reproduction number, R, defined as the average number of secondary cases infected by an infected individual. The estimate of R is informative as if R is above the threshold value 1, and remains above 1, the outbreak is likely to grow further, whereas if R is below 1, and remains below 1, the outbreak will die out.

Our method assumes that the daily incidence can be approximated by a Poisson process using the so-called renewal equation:

$$ I_t \sim Pois\left( R_t \Sigma_{s=1}^{t} I_{t-s} w_s \right) $$


where $I_t$ is the incidence (of deaths) on day $t$, $R_t$ is the reproduction number on day $t$, and $w$ is the probability mass function of the serial interval. 

Forward projections

For each country, we used the renewal equation to project the incidence forward, given an estimated reproduction number, and the observed incidence of death. We sampled a set of reproduction numbers from the posterior distribution obtained in the estimation process. For each of these sets, we simulated stochastic realisations of the renewal equation from the end of the calibration period; leading projected incidence trajectories. 

Projections were made on a 7-days horizon. The projections assume that the transmissibility remains constant over this 7-days horizon. If transmissibility were to decrease as a result of control interventions and/or changes in behaviour over this time period, we would predict a lower number of cases; similarly, if transmissibility were to increase over this time period, we would predict a higher number of cases. We limited our projection to 7 days only as assuming constant transmissibility over longer time horizons seemed unrealistic. 

Super-spreading has been shown to be an important characteristics of many coronaviruses. To account for this characteristic, we, assumed that secondary cases are generated according to a negative binomial distribution: 

$$I_t \sim NegBin\left( R_t \Sigma_{s=1}^{t} I_{t-s} w_s, z \right) $$

The value of the overdispersion parameter, z, was taken from analyses of exposure patterns during the SARS epidemic [lloyds-smith sars nature]. 
 
#### Projections 

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6.4}
obs <- drake::readd("obs")
pred <- drake::readd("model_1")
pred <- pred[pred$si == "si_1", ]
pred$date <- as.Date(pred$date)
projection_plot(obs, pred)

```

#### Effective Reproduction Number Estimates

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6.4}
rt <- drake::readd("model_1_rt")
rt <- rt[rt$si == "si_1", ]
rt <- rt[rt$proj == "RtI0_Std_results_week_end_2020-03-22", ]
rt_plot(rt)

```

#### Summary of results

```{r echo = FALSE, warning = FALSE, message = FALSE}
x <- drake::readd("formatted_weekly_predictions_qntls")[[1]]
x <- x[grep("RtI0", x$model), ]
x <- dplyr::select(x, -model)
knitr::kable(
    x,
    ##align = "l",
    digits = 2,
    ##table.attr='class="table-fixed-header"'
    ) %>%
    kable_styling(
        bootstrap_options = "striped",
        ##full_width = F,
        ##position = "center",
        fixed_thead = TRUE
    ) %>% row_spec(0, align = "left")

```


### Model 2 {.tabset .tabset-fade .tabset-pills} 

#### Methods

Estimating current transmissibility

The methods is very similar to that of model but given uncertainty surrounding the epidemiological situation before the calibration period, we only used incidence data during the calibration period, and reconstructed the incidence before the calibration period whilst estimating R, as described in [Nouvellet 2018 simple approach]. The model has the advantage of being more robust to changes in reporting before the calibration.


Forward projections

As for model 1, we used the renewal equation to project the incidence forward, given a back-calculated early incidence curve, an estimated reproduction number, and the observed incidence over the calibration period. We sampled a sets of back-calculated early incidence curves and reproduction numbers from the posterior distribution obtained in the estimation process. For each of these sets, we simulated stochastic realisations of the renewal equation from the end of the calibration period; leading to projected incidence trajectories. 

Projections were made on a 7-days horizon. The projections assume that the transmissibility remains constant over this horizon. If transmissibility were to decrease as a result of control interventions and/or changes in behaviour over this time period, we would predict a lower number of cases; similarly, if transmissibility were to increase over this time period, we would predict a higher number of cases. We limited our projection to 7 days only as assuming constant transmissibility over longer time horizons seemed unrealistic. 



#### Projections

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6.4}
pred <- drake::readd("model_2") 
pred <- pred[pred$si == "si_1", ]
pred$date <- as.Date(pred$date)
projection_plot(obs, pred)
```

#### Effective Reproduction Number Estimates

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6.4}

rt <- drake::readd("model_2_rt")
rt <- rt[rt$si == "si_1", ]
rt <- rt[rt$proj == "sbkp_Std_results_week_end_2020-03-22", ]
rt_plot(rt)

```

#### Summary of results


```{r echo = FALSE, warning = FALSE, message = FALSE}
x <- drake::readd("formatted_weekly_predictions_qntls")[[1]]
x <- x[grep("sbkp", x$model), ]
x <- dplyr::select(x, -model)
knitr::kable(
    x,
    ##align = "l",
    digits = 2
    ) %>% kable_styling() %>%
     row_spec(0, align = "left")

```


## Sensitivity Analyses


Results with a longer Serial Interval.

### Projections

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6.4}

ensb_pred2 <- ensb_pred[ensb_pred$si == "si_2", ]
ensb_pred2$date <- as.Date(ensb_pred2$date)
projection_plot(obs, ensb_pred2)

```

### Effective Reproduction Number Estimates


## Case Ascertainment

Average and 95%CI for ratio of deaths (with a 10-days delay) to reported cases for moving window of 7 days since march.

The ratio roughly accounts for the delay between death and case being reported. 



When deaths exceed the number of reported cases 10-days before, we set the reporting at 1 (95%CI [1;1])



Any temporal trend suggests a change in the reporting. 
For instance, an increase in the ratio gives an indication that cases reporting is decreasing.



```{r echo = FALSE, warning = FALSE, message = FALSE}
date_week_finishing <-  as.Date('22/03/2020',format = '%d/%m/%Y')
delay_report_death <- 10 # need checking!!

day.project <- 7
t.window.range <- 7

rep <- 2e4
d <- readRDS(file = here::here(paste0('Team.input/data_',date_week_finishing,'.rds')))

D <- d$D_active_transmission
I <- d$I_active_transmission
country <- d$Country
N_geo <- length(country)
date_week_finishing <- d$date_week_finishing

##colSums(D[,-1])/colSums(I[,-1])

date <- D$dates[7:(nrow(D)-delay_report_death)]
moving_DtoI <- list()

med <- matrix(NA,length(date),N_geo)
low <- med
up <- med

for (i in 1:nrow(med)){
  x = colSums(D[i:(i+6)+delay_report_death,-1])
  n = colSums(I[(i:(i+6)),-1])
  temp <- Hmisc::binconf(x = x , 
                  n = n,alpha = .05, method = 'exact')
  
  temp[which(x>n),] <- 1
  temp[which(n==0),] <- NA
  
  med[i,] <- temp[,1]
  low[i,] <- temp[,2]
  up[i,] <- temp[,3]
}

# med[which((med==Inf))] <- NA

for (i in 1:N_geo){
  moving_DtoI[[as.character(country[i])]] <- data.frame(date = date,
                                                        ratio = med[,i],
                                                        lower = low[,i],
                                                        upper = up[,i])
}

```

In the plots below, both reported deaths (red) and cases (black) have
been rescaled but are comparable to each other. The rescaling is such
that the maximium recorded numbers of death or cases (with a 10-days
delay) reaches 1.

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6.4}
f <- which(moving_DtoI[[1]]$date >= as.Date(c('01/03/2020'),format = '%d/%m/%Y'))

layout(matrix(1:4,2,2))
for (i in 1:N_geo){
  a <- moving_DtoI[[i]]
  plot(a$date,a$ratio,lwd = 2,
       #ylim = c(0,max(a[f,2:4],na.rm=TRUE)),
       ylim=c(0,1),
       type='l',
       xlim = c(as.Date(c('01/03/2020'),format = '%d/%m/%Y'),date_week_finishing-delay_report_death),
       bty ='n', main = country[i],col = rgb(0,0,1),
       xlab = '', ylab = 'ratio D to I') 
  
  polygon(c(a$date,rev(a$date)),
          c(a$lower,rev(a$upper)),
          border = NA,
          col = rgb(0,0,1,0.2))
  f2 <- which( I$dates %in% a$date)
  
  f2<-f2[f]
  inc <- cbind(I[f2,i+1],D[f2+delay_report_death,i+1])
  lines(a$date[f], 
        inc[,1]/max(c(inc[,1],inc[,2])),
        type = 'p', pch=16,col='black')
  
  lines(a$date[f], 
        inc[,2]/max(c(inc[,1],inc[,2])), 
        type = 'p', pch=16,col='red')
  
  if(i==3){
  legend('topleft',legend = c('ratio','death','reported cases'),bty='n',
         lwd=c(3,NA,NA),pch=c(NA,16,16),col = c(rgb(0,0,1),rgb(1,0,0),rgb(0,0,0)))
  }
}

```

Average and 95%CI for ratio of deaths to reported cases for the last 14 days.


If all cases (incl. asymptomatics) and death were reported, and the delay fro reporting was exactly 10 days, then the ratio defined would be equivalent to the CFR.

Suprisingly, this appear to be pretty much the case for South Korea
(see below).

```{r echo = FALSE, warning = FALSE, message = FALSE}
x <- readr::read_csv(here::here("Team.output/summary_DeathToRepoted_14days.csv"))
knitr::kable(x[, -1]) %>%
    kable_styling() 

```


## References

The forecasts produced relies on reported daily counts of deaths per country available on the eCDC website:

https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide


Cori A, Ferguson NM, Fraser C, Cauchemez S. A New Framework and Software to Estimate Time-Varying Reproduction Numbers During Epidemics. Am J Epidemiol. 2013; 178: 1505-1512.

Wang Y, Teunis T. Strongly heterogeneous transmission of COVID-19 in mainland China: local and regional variation. March 10, 2020. medRxiv

Ferguson et al. 2020. Report 9: Impact of non-pharmaceutical interventions (NPIs) to reduce COVID-19 mortality and healthcare demand. https://www.imperial.ac.uk/mrc-global-infectious-disease-analysis/news--wuhan-coronavirus/

Lloyd-Smith  JO, Schreiber SJ, Kopp PE, Getz WM. Superspreading and the effect of individual variation on disease emergence. Nature, 2005; 438, 355-359.

Nouvellet P et al. A simple approach to measure transmissibility and forecast incidence. Epidemics, 2018; 22. 29-35.
