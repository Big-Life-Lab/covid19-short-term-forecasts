---
output: 
html_document:
  css: style.css
citation_package: natbib
keep_tex: false
fig_caption: true
latex_engine: pdflatex
title: "Short-term forecasts of cases and deaths of COVID-19 in multiple countries"
author:
- name: Sangeeta Bhatia and Pierre Nouvellet
affiliation: Imperial College London
abstract: 
keywords: 
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
spacing: double
bibliography: 
biblio-style: apsr
endnote: no
---

```{r echo = FALSE, warning = FALSE, message = FALSE}
library(ggplot2)
library(ggpubr)
library(dplyr)
library(drake)
library(kableExtra)
library(DT)
source("R/util.R")
raw_data <- drake::readd(raw_data)
raw_data <- dplyr::rename(raw_data, country = "Countries.and.territories")


```
# Introduction {.tabset .tabset-fade .tabset-pills}

As of `r format(Sys.time(), '%B %d, %Y')`, there have more than
351,000 cases of COVID-19 across the world, with more than 15,000
deaths. In this report, we use the reported number of deaths
of COVID-19 to make short term forecasts of the trajectory of the
outbreak. 

## Summary

### Objectives and caveats

The **main** objective in this report is to produce forecasts of the 
number of deaths in the week ahead per country with active transmission.

* We define a country to have sustained local active transmission if
at least five deaths were observed in the country in the last week and also in the week before that.

* We forecast deaths as it is likely that reporting of deaths is more
reliable than reporting of cases. Temporal trends in reporting of
deaths are also likely to be more stable than trends in reporting
cases.

* Because we are forecasting deaths, latest estimates of
transmissibility reflect the epidemiological situation when those
dying were infected. Therefore, in the best case scenario, the
impact of current controls on estimated transmissibility will be
quantifiable with a delay (i.e. delay between reporting and death).


A **secondary** objective of this report is to analyse case
ascertainment per country. As well as forecasting, we use the number of reported deaths and of past reported
cases (using a fixed delay) to analyse the reporting trends per
country. If the reporting of cases and death was perfect, as well as
the delay between reporting and death fixed and known, the ratio of
deaths to delayed cases would be exactly the Case Fatality Ratio (CFR).

In this analysis, key assumptions are:

* The true underlying Case Fatality Ratio (CFR) is 1%,
* The delay from a case being reported to death is 10 days.

### Key results on transmissibility and forecasting

Key results below are based on ensemble forecast.

Transmissibility is characterised by the reproduction number, i.e. the 
average number of cases that one infected is likely to
infect. Analysis of transmissibility indicates that the reproduction 
number last week (week starting 22nd March) was highest in:
  
* Germany with an estimated median Rt of: 4.5 (95% CrI 5.9 - 3.5), and
* USA with an estimated median Rt of 4.3 (95% CrI 3.4 - 4.8);

and was lowest in:
  
* Japan with an estimated Rt of 0.6 (95% CrI 1.2 - 0.2), and
* China with an estimated Rt of 0.8 (95% CrI 0.6 - 1.0).

Forecast of predicted deaths in the coming week (week starting [date]) is highest in:
  
* Italy with a forecasted number of weekly deaths 9030 (95% CrI 7813 - 10400), and
* Spain with a forecasted number of weekly deaths 5628 (95% CrI 3950 -
  8654);

and is lowest in:
  
* Japan with a forecasted number of weekly deaths 6 (95% CrI 0 - 44), and
* Iraq with a forecasted number of weekly deaths 14 (95% CrI 0 - 825).

Forecasts in previous weeks were good with 90.1% of observed number
of daily deaths across all countries included in the 95% CrI of the forecast
intervals.

### Key results on case ascertainment

Case ascertainment was estimated based on the deaths in the previous 2 weeks  and 
reported cases in the 10 days prior to that period. Results indicate that 
countries with highest case ascertainment were:
  
* South Korea with an estimated ascertainment of 100% (95% CrI 89.2% - 100%), and
* Germany with an estimated ascertainment of 23.1% (95% CrI 18.3% - 29.6%);

and countries with the lowest case ascertainment were:
  
* Spain with an estimated ascertainment of 1.6% (95% CrI 1.6% - 1.7%), and
* Philippines with an estimated ascertainment of: 1.9% (95% CrI 1.5% - 2.7%).

Based on the estimated ascertainment, we estimated the true size of
the epidemics in the previous 7 days (week starting 15th March). 
Countries with the highest true epidemics size in this period were:
  
* Italy with an estimated true epidemics size in this period of
  1364565 (95% CrI 1333474 - 1395862), and
* Spain with an estimated true epidemics size in this period of
1190204 (95% CrI 1149931 - 1229837).

and countries with the lowest true epidemics size in this period were:
  
* South Korea with an estimated true epidemics size in this period of
  735 (95% CrI 735 - 824), and
* Japan with an estimated true epidemics size in this period of
1843 (95% CrI 1256 - 2592).

## Methods

We define a country to have sustained local active transmission if
at least five deaths were observed in the country in the last week and also in the week before that. We intend to produce forecasts every week, for the
week ahead. So far, three different modelling teams will produce these
forecats which are then used to produce an ensemble forecasts.

Our main analysis assumes a gamma distributed serial of mean 4.8 days
and standard deviation of 2.7 days following [Wang and Teunis, 2020].
The serial interval estimates might be biased toward lower values given
the observation bias whereby, in contact tracing studies, long serial
interval tend to be under-represented. To account for this, as a
sensitivity analysis, we also ran our analysis with an alternative
longer serial interval of mean 6.48 days and standard deviation of
3.83 days [Ferguson 2020, report 9]. Results for this longer interval
are presented in the supplementary information section. Most
importantly, while using such a longer serial interval has very little
impact on the weekly forecast produced, it results in much higher
estimated of transmissibility.


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6.4}

short <- EpiEstim::discr_si(0:90, 4.8, 2.7)
long <- EpiEstim::discr_si(0:90, 6.48, 3.83)
df <- data.frame(
    x = c(0:90, 0:90),
    cat = c(rep("short", 91), rep("long", 91)),
    val = c(short, long)
)
ggplot(df, aes(x, val, fill = cat)) +
    geom_col(position = "dodge") +
    theme_pubr() +
    theme(legend.position = "none") +
    xlab("") +
    ylab("")
    
```




## Projections and Rt Estimates {.tabset .tabset-fade .tabset-pills} 

### Ensemble Model {.tabset .tabset-fade .tabset-pills} 

### Methods

This is an unweighted ensemble of models 1 and 2.

#### Projections

**Current and past forecasts**

Below for each country with active transmission (see methods), we plot
the observed incidence of deaths in the last 3 weeks (black
dots). Past forecasts, where available, are shown in green (median and
95%CrI band), while latest forecasts are show in red. Horizontal
dashed line show the start and end of each week (Monday to Sunday).


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6.4}

obs <- drake::readd("obs")
ensb_pred <- drake::readd("ensemble_model_qntls")
ensb_pred1 <- ensb_pred[ensb_pred$si == "si_1", ]
ensb_pred1$date <- as.Date(ensb_pred1$date)
projection_plot(obs, ensb_pred1)

```

**Estimates of effective Reproduction Numbers**

Below, estimates of effective Reproduction Numbers by country (median and 95%CrI).

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6.4}
ens_rt <- drake::readd("ensemble_model_rt")
ens_rt <- ens_rt[ens_rt$si == "si_1", ]
ens_rt$model <- as.Date(ens_rt$model)
ens_rt <- ens_rt[ens_rt$model == max(ens_rt$model), ]
ens_rt <- tidyr::spread(ens_rt, quantile, out2)
rt_plot(ens_rt)

```

#### Summary of results

Below for each country with active transmission (see methods), a table 
summarising for each period and country forecasted, the observed
(where available) and forecasted weekly death count, and estimated
levels of transmissibility.


```{r echo = FALSE, warning = FALSE, message = FALSE}

x <- drake::readd("fmtd_ensemble_weekly_qntls")[[1]]

## knitr::kable(
##     x,
##     align = "l",
##     digits = 2
## ) %>% kable_styling()

DT::datatable(x)

```

### Model 1 {.tabset .tabset-fade .tabset-pills} 

#### Methods


**Estimating current transmissibility**

We use a previously described approach [cori et al. 2013] to quantify
transmissibility during the calibration period, from the incidence of
death time series, assuming a certain distribution for the serial
interval for death (the time between death in a case and death in
their infector). Here, we assumed that the serial interval
distribution for death was similar to the classical serial interval
distribution (the time between onset of symptom in a case and onset of
symptom in their infector).


We assume that transmissibility was constant throughout the
calibration period, and measured it through the reproduction number,
R, defined as the average number of secondary cases infected by an
infected individual. The estimate of R is informative as if R is above
the threshold value 1, and remains above 1, the outbreak is likely to
grow further, whereas if R is below 1, and remains below 1, the
outbreak will die out.


Our method assumes that the daily incidence can be approximated by a
Poisson process using the renewal equation:


$$ I_t \sim Pois\left( R_t \Sigma_{s=1}^{t} I_{t-s} w_s \right) $$


where $I_t$ is the incidence (of deaths) on day $t$, $R_t$ is the
reproduction number on day $t$, and $w$ is the probability mass
function of the serial interval. 


**Forward projections**

For each country, we used the renewal equation to project the
incidence forward, given an estimated reproduction number, and the
observed incidence of death. We sampled a set of reproduction numbers
from the posterior distribution obtained in the estimation
process. For each of these sets, we simulated stochastic realisations
of the renewal equation from the end of the calibration period;
leading projected incidence trajectories. 


Projections were made on a 7-days horizon. The projections assume that
the transmissibility remains constant over this 7-days horizon. If
transmissibility were to decrease as a result of control interventions
and/or changes in behaviour over this time period, we would predict a
lower number of cases; similarly, if transmissibility were to increase
over this time period, we would predict a higher number of cases. We
limited our projection to 7 days only as assuming constant
transmissibility over longer time horizons seemed unrealistic. 


Super-spreading has been shown to be an important characteristics of
many coronaviruses. To account for this characteristic, we, assumed
that secondary cases are generated according to a negative binomial
distribution: 


$$I_t \sim NegBin\left( R_t \Sigma_{s=1}^{t} I_{t-s} w_s, z \right) $$

The value of the overdispersion parameter, z, was taken from analyses
of exposure patterns during the SARS epidemic [lloyds-smith et al. 2003]. 

 
#### Projections 

**Current and past forecasts**

Below for each country with active transmission (see methods), we plot
the observed incidence of deaths in the last 3 weeks (black
dots). Past forecasts, where available, are shown in green (median and
95%CrI band), while latest forecasts are show in red. Horizontal
dashed line show the start and end of each week (Monday to Sunday).


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6.4}
obs <- drake::readd("obs")
pred <- drake::readd("model_2")
pred <- pred[pred$si == "si_1", ]
pred$date <- as.Date(pred$date)
projection_plot(obs, pred)

```

#### Effective Reproduction Number Estimates

In the figure below, for each country with active transmission (see
methods), we plot the latest estimate of transmissibility ($R_t$),
specifically estimated median and associated 95%CrI.


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6.4}
rt <- drake::readd("model_2_rt")
rt <- rt[rt$si == "si_1", ]
rt <- rt[rt$proj == "sbkp_Std_results_week_end_2020-03-22", ]
rt_plot(rt)

```

#### Summary of results

Below for each country with active transmission (see methods), a table
summarising for each period and country forecasted, the observed
(where available) and forecasted weekly death count, and estimated
level of transmissibility.


```{r echo = FALSE, warning = FALSE, message = FALSE}

x <- drake::readd("formatted_weekly_predictions_qntls")[[1]]
x <- x[grep("sbkp", x$model), ]
x <- dplyr::select(x, -model)
DT::datatable(x)

```


### Model 2 {.tabset .tabset-fade .tabset-pills} 

#### Methods

**Estimating current transmissibility**

The methods is very similar to that of model but given uncertainty surrounding the epidemiological situation before the calibration period, we only used incidence data during the calibration period, and reconstructed the incidence before the calibration period whilst estimating R, as described in [Nouvellet et al. 2018]. The model has the advantage of being more robust to changes in reporting before the calibration.


**Forward projections**

As for model 1, we used the renewal equation to project the incidence forward, given a back-calculated early incidence curve, an estimated reproduction number, and the observed incidence over the calibration period. We sampled a sets of back-calculated early incidence curves and reproduction numbers from the posterior distribution obtained in the estimation process. For each of these sets, we simulated stochastic realisations of the renewal equation from the end of the calibration period; leading to projected incidence trajectories. 

Projections were made on a 7-days horizon. The projections assume that the transmissibility remains constant over this horizon. If transmissibility were to decrease as a result of control interventions and/or changes in behaviour over this time period, we would predict a lower number of cases; similarly, if transmissibility were to increase over this time period, we would predict a higher number of cases. We limited our projection to 7 days only as assuming constant transmissibility over longer time horizons seemed unrealistic. 



#### Projections

**Current and past forecasts**

Below for each country with active transmission (see methods), we plot the observed incidence of deaths in the last 3 weeks (black dots). Past forecasts, where available, are shown in green (median and 95%CrI band), while latest forecasts are show in red. Horizontal dashed line show the start and end of each week (Monday to Sunday).


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6.4}
pred <- drake::readd("model_2") 
pred <- pred[pred$si == "si_1", ]
pred$date <- as.Date(pred$date)
projection_plot(obs, pred)
```

#### Effective Reproduction Number Estimates

In the figure below, for each country with active transmission (see methods), we plot the latest estimate of transmissibility ($R_t$), specifically estimated median and associated 95%CrI.

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6.4}

rt <- drake::readd("model_2_rt")
rt <- rt[rt$si == "si_1", ]
rt <- rt[rt$proj == "sbkp_Std_results_week_end_2020-03-22", ]
rt_plot(rt)

```

#### Summary of results

Below for each country with active transmission (see methods), a table summarising for each period and country forecasted, the observed (where available) and forecasted weekly death count, and estimated level of transmissibility.

```{r echo = FALSE, warning = FALSE, message = FALSE}

x <- drake::readd("formatted_weekly_predictions_qntls")[[1]]
x <- x[grep("sbkp", x$model), ]
x <- dplyr::select(x, -model)
DT::datatable(x)

```


## Sensitivity Analyses


Results below use a longer Serial Interval (mean 6.48 days, SD 3.83 days).

### Projections

Below for each country with active transmission (see methods), we plot the observed incidence of deaths in the last 3 weeks (black dots). Past forecasts, where available, are shown in green (median and 95%CrI band), while latest forecasts are show in red. Horizontal dashed line show the start and end of each week (Monday to Sunday).

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6.4}

ensb_pred2 <- ensb_pred[ensb_pred$si == "si_2", ]
ensb_pred2$date <- as.Date(ensb_pred2$date)
projection_plot(obs, ensb_pred2)

```

### Effective Reproduction Number Estimates

In the figure below, for each country with active transmission (see methods), we plot the latest estimate of transmissibility ($R_t$), specifically estimated median and associated 95%CrI.

## Case Ascertainment

The analysis rely on 2 key assumptions:
  
* The true underlying Case Fatality Ratio (CFR) is 1%,
* The delay from a death to this case being reported is 10 days.

First, we analyses the ratio of reported deaths to reported cases 10 days prior.
Therefore, the ratio roughly accounts for the delay between death and case being reported. 

Any temporal trend suggests a change in the reporting. 
For instance, an increase in the ratio gives an indication that cases reporting is decreasing.


**Temporal trend in the ratio of deaths to reported cases**

Starting in march, we compute the average and 95%CI for the ratio of deaths  to reported cases (with a 10-days delay) using a moving window of 7 days.


```{r echo = FALSE, warning = FALSE, message = FALSE}
date_week_finishing <-  as.Date('22/03/2020',format = '%d/%m/%Y')
delay_report_death <- 10 # need checking!!

day.project <- 7
t.window.range <- 7

rep <- 2e4
d <- readRDS(file = here::here(paste0('Team.input/data_',date_week_finishing,'.rds')))

D <- d$D_active_transmission
I <- d$I_active_transmission
country <- d$Country
N_geo <- length(country)
date_week_finishing <- d$date_week_finishing

##colSums(D[,-1])/colSums(I[,-1])

date <- D$dates[7:(nrow(D)-delay_report_death)]
moving_DtoI <- list()

med <- matrix(NA,length(date),N_geo)
low <- med
up <- med

for (i in 1:nrow(med)){
  x = colSums(D[i:(i+6)+delay_report_death,-1])
  n = colSums(I[(i:(i+6)),-1])
  temp <- Hmisc::binconf(x = x , 
                  n = n,alpha = .05, method = 'exact')
  
  temp[which(x>n),] <- 1
  temp[which(n==0),] <- NA
  
  med[i,] <- temp[,1]
  low[i,] <- temp[,2]
  up[i,] <- temp[,3]
}

# med[which((med==Inf))] <- NA

for (i in 1:N_geo){
  moving_DtoI[[as.character(country[i])]] <- data.frame(date = date,
                                                        ratio = med[,i],
                                                        lower = low[,i],
                                                        upper = up[,i])
}

```

The figure below shows the temporal trends in the ratio of reported deaths to reported cases 10 days prior (medians and 95%CIs, solid lines and bands).
We also plot both the reported deaths (red) and reported cases (black). Those have
been rescaled but are comparable to each other. The rescaling is such
that the maximium recorded numbers of deaths or cases (with a 10-days
delay) reaches 1.

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6.4}
f <- which(moving_DtoI[[1]]$date >= as.Date(c('01/03/2020'),format = '%d/%m/%Y'))

layout(matrix(1:4,2,2))
for (i in 1:N_geo){
  a <- moving_DtoI[[i]]
  plot(a$date,a$ratio,lwd = 2,
       #ylim = c(0,max(a[f,2:4],na.rm=TRUE)),
       ylim=c(0,1),
       type='l',
       xlim = c(as.Date(c('01/03/2020'),format = '%d/%m/%Y'),date_week_finishing-delay_report_death),
       bty ='n', main = country[i],col = rgb(0,0,1),
       xlab = '', ylab = 'ratio D to I') 
  
  polygon(c(a$date,rev(a$date)),
          c(a$lower,rev(a$upper)),
          border = NA,
          col = rgb(0,0,1,0.2))
  f2 <- which( I$dates %in% a$date)
  
  f2<-f2[f]
  inc <- cbind(I[f2,i+1],D[f2+delay_report_death,i+1])
  lines(a$date[f], 
        inc[,1]/max(c(inc[,1],inc[,2])),
        type = 'p', pch=16,col='black')
  
  lines(a$date[f], 
        inc[,2]/max(c(inc[,1],inc[,2])), 
        type = 'p', pch=16,col='red')
  
  if(i==3){
  legend('topleft',legend = c('ratio','death','reported cases'),bty='n',
         lwd=c(3,NA,NA),pch=c(NA,16,16),col = c(rgb(0,0,1),rgb(1,0,0),rgb(0,0,0)))
  }
}

```

*Note that if deaths exceed the number of reported cases 10-days before, we set the ratio at 1 (95%CI [1;1])*

**Estimating ascertainment**

If all cases (incl. asymptomatic) and deaths were reported, and the delay from reporting to death was exactly 10 days, then the ratio defined above would be equivalent to the Case Fatality Ratio (CFR).

Assuming a CFR of 1%, the ascertainment, $\rho$, can be defined as:
$$\rho = \frac{I^r}{D^r} CFR$$
with $D^r$ and $I^r$ the reported number of deaths and cases (with a 10-days delay).

And the ratio previously defined is 
$$\frac{D^r}{I^r}$$

Below we summarise:

* Estimated ratio per country (mean and 95%CI) during the last 14 days, 
* Estimated case ascertainment per country (mean and 95%CI) during the last 14 days,
* Estimated factor to be multiplied to observed cases number to obtain true number of cases. Mean and 95%CI, estimated for the last 14 days.
* Observed and predicted number of cases in the last week (week starting [date]).

Average and 95%CI for ratio of deaths to reported cases for the last 14 days.
Surprisingly, this appear to be pretty much the case for South Korea
(see below).

```{r echo = FALSE, warning = FALSE, message = FALSE}
x <- readr::read_csv(here::here("Team.output/summary_DeathToRepoted_14days.csv"))
knitr::kable(x[, -1]) %>%
    kable_styling() 

```


## References

The forecasts produced relies on reported daily counts of deaths per country available on the eCDC website:

https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide

Other references:

* Cori A, Ferguson NM, Fraser C, Cauchemez S. A New Framework and Software to Estimate Time-Varying Reproduction Numbers During Epidemics. Am J Epidemiol. 2013; 178: 1505-1512.

* Wang Y, Teunis T. Strongly heterogeneous transmission of COVID-19 in mainland China: local and regional variation. March 10, 2020. medRxiv

* Ferguson et al. 2020. Report 9: Impact of non-pharmaceutical interventions (NPIs) to reduce COVID-19 mortality and healthcare demand. https://www.imperial.ac.uk/mrc-global-infectious-disease-analysis/news--wuhan-coronavirus/

* Lloyd-Smith  JO, Schreiber SJ, Kopp PE, Getz WM. Superspreading and the effect of individual variation on disease emergence. Nature, 2005; 438, 355-359.

* Nouvellet P et al. A simple approach to measure transmissibility and forecast incidence. Epidemics, 2018; 22. 29-35.
